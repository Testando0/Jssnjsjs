<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KuromiFlix - Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Martel+Sans:wght@200;300;400;600;700;800&display=swap');
        body { background-color: #141414; color: white; font-family: 'Martel Sans', sans-serif; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hero-gradient { background: linear-gradient(to top, #141414 10%, transparent 90%); }
        .nav-black { background-color: #141414; }
        .poster-card { transition: transform 0.3s ease; cursor: pointer; }
        .poster-card:hover { transform: scale(1.05); }
        
        /* Anti-Popup Overlay */
        #anti-popup-shield {
            position: absolute;
            inset: 0;
            z-index: 201;
            display: none; /* Ativado via JS ao dar play */
        }
    </style>
</head>
<body>

    <div id="search-overlay" class="fixed inset-0 bg-black/95 z-[150] hidden flex-col p-8">
        <div class="flex justify-between items-center mb-8">
            <input type="text" id="search-input" placeholder="Títulos, pessoas, gêneros..." 
                class="bg-transparent border-b-2 border-white text-2xl w-full focus:outline-none p-2">
            <button onclick="toggleSearch()" class="text-3xl ml-4"><i class="fas fa-times"></i></button>
        </div>
        <div id="search-results" class="grid grid-cols-2 md:grid-cols-5 gap-4 overflow-y-auto no-scrollbar"></div>
    </div>

    <div id="app-content">
        <nav id="navbar" class="fixed top-0 w-full z-50 transition-all duration-300 px-4 md:px-12 py-4 flex items-center justify-between">
            <div class="flex items-center gap-8">
                <a href="#" onclick="showPage('home')" class="text-red-600 text-3xl font-bold tracking-tighter">KUROMIFLIX</a>
                <ul class="hidden md:flex gap-4 text-sm font-semibold">
                    <li><button onclick="showPage('home')" class="hover:text-gray-300">Início</button></li>
                    <li><button onclick="showPage('series')" class="hover:text-gray-300">Séries</button></li>
                    <li><button onclick="showPage('filmes')" class="hover:text-gray-300">Filmes</button></li>
                    <li><button onclick="showPage('animes')" class="hover:text-gray-300">Animes</button></li>
                </ul>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="toggleSearch()" class="text-white text-xl"><i class="fas fa-search"></i></button>
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png" class="w-8 h-8 rounded">
            </div>
        </nav>

        <main id="main-view"></main>
    </div>

    <div id="player-overlay" class="fixed inset-0 z-[200] bg-black hidden flex-col">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-[210] bg-gradient-to-b from-black to-transparent">
            <button onclick="closePlayer()" class="text-white text-lg bg-black/50 px-4 py-2 rounded"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>
        </div>
        
        <div class="relative w-full h-full flex items-center justify-center">
            <div id="anti-popup-shield" onclick="this.style.display='none'"></div>
            <div id="iframe-container" class="w-full h-full"></div>
        </div>
    </div>

    <script>
        const API_KEY = '8265bd1679663a7ea12ac168da84d2e8';
        const BASE_URL = 'https://api.themoviedb.org/3';
        
        // --- PESQUISA ---
        function toggleSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.toggle('hidden');
            if(!overlay.classList.contains('hidden')) document.getElementById('search-input').focus();
        }

        document.getElementById('search-input').addEventListener('input', async (e) => {
            const query = e.target.value;
            if(query.length < 3) return;
            
            const url = `${BASE_URL}/search/multi?api_key=${API_KEY}&language=pt-BR&query=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            const data = await res.json();
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = data.results.map(item => `
                <div onclick="startPlayer('${item.media_type === 'tv' ? 'serie' : 'filme'}', ${item.id})" class="poster-card">
                    <img src="https://image.tmdb.org/t/p/w300${item.poster_path}" class="rounded">
                    <p class="text-xs mt-2">${item.title || item.name}</p>
                </div>
            `).join('');
        });

        // --- PLAYER COM AUTOPLAY E BLOQUEIO ---
        async function startPlayer(type, id) {
            const overlay = document.getElementById('player-overlay');
            const container = document.getElementById('iframe-container');
            const shield = document.getElementById('anti-popup-shield');

            // Superflix URL com parâmetro de autoplay (se suportado pela API deles)
            const playerUrl = `https://superflixapi.asia/${type}/${id}`;
            
            const iframe = document.createElement('iframe');
            iframe.src = playerUrl;
            iframe.className = "w-full h-full";
            iframe.allowFullscreen = true;
            // Autoplay e Encrypted Media são essenciais
            iframe.allow = "autoplay; encrypted-media; fullscreen"; 
            
            // BLOQUEIO DE POPUP: 
            // Usamos sandbox mas SEM 'allow-popups'. 
            // Isso impede que o player abra novas abas/anúncios.
            iframe.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-presentation');

            container.innerHTML = '';
            container.appendChild(iframe);
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            shield.style.display = 'block'; // Ativa proteção inicial

            // Tenta forçar fullscreen
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            // Fecha a pesquisa se estiver aberta
            document.getElementById('search-overlay').classList.add('hidden');
        }

        function closePlayer() {
            document.getElementById('iframe-container').innerHTML = '';
            document.getElementById('player-overlay').classList.add('hidden');
            if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
        }

        // --- CARREGAMENTO INICIAL (SIMPLIFICADO) ---
        async function fetchTMDB(endpoint) {
            const res = await fetch(`${BASE_URL}${endpoint}?api_key=${API_KEY}&language=pt-BR`);
            const data = await res.json();
            return data.results;
        }

        async function showPage(page) {
            const main = document.getElementById('main-view');
            main.innerHTML = '<p class="p-20 text-center">Carregando...</p>';
            
            let endpoint = '/trending/all/week';
            if(page === 'series') endpoint = '/tv/popular';
            if(page === 'filmes') endpoint = '/movie/popular';
            if(page === 'animes') endpoint = '/discover/tv?with_genres=16&with_original_language=ja';

            const items = await fetchTMDB(endpoint);
            
            main.innerHTML = `
                <div class="p-4 md:p-12 grid grid-cols-2 md:grid-cols-5 gap-6 mt-16">
                    ${items.map(i => `
                        <div onclick="startPlayer('${i.title ? 'filme' : 'serie'}', ${i.id})" class="poster-card">
                            <img src="https://image.tmdb.org/t/p/w500${i.poster_path}" class="rounded-lg shadow-xl">
                            <h3 class="mt-2 text-sm font-bold">${i.title || i.name}</h3>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Estilo da Navbar no Scroll
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('navbar');
            window.scrollY > 50 ? nav.classList.add('nav-black') : nav.classList.remove('nav-black');
        });

        showPage('home');
    </script>
</body>
</html>
